<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dependencies between packets • orderly2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dependencies between packets">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">orderly2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.99.81</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/orderly2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction to orderly2</a></li>
    <li><a class="dropdown-item" href="../articles/dependencies.html">Dependencies between packets</a></li>
    <li><a class="dropdown-item" href="../articles/collaboration.html">Collaborative analysis</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from orderly (1.x)</a></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Outpack metadata</a></li>
    <li><a class="dropdown-item" href="../articles/query.html">Orderly query DSL</a></li>
    <li><a class="dropdown-item" href="../articles/plugins.html">Creating plugins</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/orderly2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Dependencies between packets</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/orderly2/blob/main/vignettes/dependencies.Rmd" class="external-link"><code>vignettes/dependencies.Rmd</code></a></small>
      <div class="d-none name"><code>dependencies.Rmd</code></div>
    </div>

    
    
<p>One of the core aims of <code>orderly2</code> is to allow
collaborative analysis; to do this the end of one piece of work is an
input for another piece of work, perhaps someone else’s. To make this
work in practice, one <code>orderly2</code> report can “depend” on some
completed packet (or several completed packets) in order to pull in
files as inputs.</p>
<p>There are two levels that it is useful to think about
dependencies:</p>
<ul>
<li>At the level of the source report, as an instruction about what we
<strong>intend</strong> to depend on; this may or may not be
satisfiable</li>
<li>At the level of a completed packet, as a record about what
<strong>was</strong> depended on</li>
</ul>
<p>This perspective differs somewhat from workflow managers where it is
common to talk about “outdated dependencies” and have some single idea
of an end result that a chain of dependencies builds up to.</p>
<p>This vignette walks through some of the practical issues around
creating and working with dependencies between reports, starting from
simple cases (these will be familiar to users of <code>orderly1</code>)
through to more advanced cases. We then cover how to interrogate the
dependency graph and our ideas for extending this in future, and some
practical issues around how dependencies interact with different
locations (there is some overlap here with
<code><a href="../articles/collaboration.html">vignette("collaboration")</a></code>, which we will highlight).</p>
<div class="section level2">
<h2 id="using-dependencies">Using dependencies<a class="anchor" aria-label="anchor" href="#using-dependencies"></a>
</h2>
<p>Here, we show how to practically use dependencies in a few common
scenarios of increasing complexity. The code examples are purposefully
too-simple in order to keep the presentation straightforward, see the
end of this document for a discussion of how complex these pieces of
code might “optimally” be.</p>
<div class="section level3">
<h3 id="basic-use">Basic use<a class="anchor" aria-label="anchor" href="#basic-use"></a>
</h3>
<p>The primary mechanism for using dependencies is to call
<code><a href="../reference/orderly_dependency.html">orderly2::orderly_dependency()</a></code> from within an orderly file;
this finds a suitable completed packet and copies files that are found
from within that packet into your current report.</p>
<pre><code><span><span class="co">## <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">## ├── <span style="color: #0000BB; font-weight: bold;">analysis</span></span></span>
<span><span class="co">## │   └── <span style="color: #00BB00;">analysis.R</span></span></span>
<span><span class="co">## └── <span style="color: #0000BB; font-weight: bold;">data</span></span></span>
<span><span class="co">##     ├── <span style="color: #00BB00;">data.R</span></span></span>
<span><span class="co">##     └── data.csv</span></span></code></pre>
<p>and <code>src/analysis/analysis.R</code> contains:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"latest()"</span>, <span class="st">"data.rds"</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="st">"analysis.png"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Here, we’ve used <code><a href="../reference/orderly_dependency.html">orderly2::orderly_dependency()</a></code> to pull
in the file <code>data.rds</code> from the most recent version
(<code>latest()</code>) of the <code>data</code> packet, then we’ve used
that file as normal to make a plot, which we’ve saved as
<code>analysis.png</code> (this is very similar to the example from
<code><a href="../articles/introduction.html">vignette("introduction")</a></code>, to get us started).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id1</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">data</span>' `20250901-150701-13f3bd36` at 2025-09-01 15:07:01.08244</span></span>
<span><span class="co">## &gt; d &lt;- read.csv("data.csv")</span></span>
<span><span class="co">## &gt; d$z &lt;- resid(lm(y ~ x, d))</span></span>
<span><span class="co">## &gt; saveRDS(d, "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">data.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150701-13f3bd36 at 2025-09-01 15:07:01.11887 (0.03642964 secs)</span></span>
<span><span class="va">id2</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"analysis"</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">analysis</span>' `20250901-150701-265868f5` at 2025-09-01 15:07:01.154173</span></span>
<span><span class="co">## &gt; orderly2::orderly_dependency("data", "latest()", "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Depending on <span style="color: #0000BB;">data</span> @ `20250901-150701-13f3bd36` (via latest(name == "data"))</span></span>
<span><span class="co">## &gt; d &lt;- readRDS("data.rds")</span></span>
<span><span class="co">## &gt; png("analysis.png")</span></span>
<span><span class="co">## &gt; plot(y ~ x, d)</span></span>
<span><span class="co">## &gt; dev.off()</span></span>
<span><span class="co">## agg_png </span></span>
<span><span class="co">##       2</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">analysis.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150701-265868f5 at 2025-09-01 15:07:01.235096 (0.08092237 secs)</span></span></code></pre></div>
<p>When we look at the metadata for the packet created from the
<code>analysis</code> report, we can see it has used
<code>20250901-150701-13f3bd36</code> as its dependency:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_metadata.html">orderly_metadata</a></span><span class="op">(</span><span class="va">id2</span><span class="op">)</span><span class="op">$</span><span class="va">depends</span></span>
<span><span class="co">##                     packet                  query        files</span></span>
<span><span class="co">## 1 20250901-150701-13f3bd36 latest(name == "data") data.rds....</span></span></code></pre></div>
<p>(indeed it had to, there is only one copy of the <code>data</code>
packet to pick from).</p>
</div>
<div class="section level3">
<h3 id="filtering-candidates-by-parameters">Filtering candidates by parameters<a class="anchor" aria-label="anchor" href="#filtering-candidates-by-parameters"></a>
</h3>
<p>In the above example, our query was as simple as it could be — the
most recently created packet with the name <code>data</code>. One common
pattern we see is that an analysis might have a parameter (for example a
country name) and a downstream analysis might share that parameter and
want to pull in data for a country.</p>
<pre><code><span><span class="co">## <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">## ├── <span style="color: #0000BB; font-weight: bold;">analysis</span></span></span>
<span><span class="co">## │   └── <span style="color: #00BB00;">analysis.R</span></span></span>
<span><span class="co">## └── <span style="color: #0000BB; font-weight: bold;">data</span></span></span>
<span><span class="co">##     └── <span style="color: #00BB00;">data.R</span></span></span></code></pre>
<p>with <code>src/data/data.R</code> containing:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_parameters.html">orderly_parameters</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">mtcars</span><span class="op">[</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span> <span class="op">==</span> <span class="va">pars</span><span class="op">$</span><span class="va">cyl</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">d</span>, <span class="st">"data.rds"</span><span class="op">)</span></span></code></pre></div>
<p>We can run this for several values of <code>cyl</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">data</span>' `20250901-150701-9a538a4b` at 2025-09-01 15:07:01.607385</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Parameters:</span></span>
<span><span class="co">## • cyl: 4</span></span>
<span><span class="co">## &gt; pars &lt;- orderly2::orderly_parameters(cyl = NULL)</span></span>
<span><span class="co">## &gt; d &lt;- mtcars[mtcars$cyl == pars$cyl, ]</span></span>
<span><span class="co">## &gt; saveRDS(d, "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">data.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150701-9a538a4b at 2025-09-01 15:07:01.638694 (0.03130841 secs)</span></span>
<span><span class="co">## [1] "20250901-150701-9a538a4b"</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">data</span>' `20250901-150701-a8a20cf0` at 2025-09-01 15:07:01.665764</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Parameters:</span></span>
<span><span class="co">## • cyl: 6</span></span>
<span><span class="co">## &gt; pars &lt;- orderly2::orderly_parameters(cyl = NULL)</span></span>
<span><span class="co">## &gt; d &lt;- mtcars[mtcars$cyl == pars$cyl, ]</span></span>
<span><span class="co">## &gt; saveRDS(d, "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">data.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150701-a8a20cf0 at 2025-09-01 15:07:01.69387 (0.02810597 secs)</span></span>
<span><span class="co">## [1] "20250901-150701-a8a20cf0"</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">data</span>' `20250901-150701-b73ff07c` at 2025-09-01 15:07:01.720214</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Parameters:</span></span>
<span><span class="co">## • cyl: 8</span></span>
<span><span class="co">## &gt; pars &lt;- orderly2::orderly_parameters(cyl = NULL)</span></span>
<span><span class="co">## &gt; d &lt;- mtcars[mtcars$cyl == pars$cyl, ]</span></span>
<span><span class="co">## &gt; saveRDS(d, "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">data.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150701-b73ff07c at 2025-09-01 15:07:01.749925 (0.02971148 secs)</span></span>
<span><span class="co">## [1] "20250901-150701-b73ff07c"</span></span></code></pre></div>
<p>Our follow-on analysis contains:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_parameters.html">orderly_parameters</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span></span>
<span>  <span class="st">"data"</span>,</span>
<span>  <span class="st">"latest(parameter:cyl == this:cyl)"</span>,</span>
<span>  <span class="st">"data.rds"</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="st">"analysis.png"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">disp</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Here the query <code>latest(parameter:cyl == this:cyl)</code> says
“find the most recent packet where it’s parameter”cyl”
(<code>parameter:cyl</code>) is the same as the parameter in the
currently running report (<code>this:cyl</code>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"analysis"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">analysis</span>' `20250901-150701-e65b86aa` at 2025-09-01 15:07:01.904314</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Parameters:</span></span>
<span><span class="co">## • cyl: 4</span></span>
<span><span class="co">## &gt; pars &lt;- orderly2::orderly_parameters(cyl = NULL)</span></span>
<span><span class="co">## &gt; orderly2::orderly_dependency(</span></span>
<span><span class="co">## +   "data",</span></span>
<span><span class="co">## +   "latest(parameter:cyl == this:cyl)",</span></span>
<span><span class="co">## +   "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Depending on <span style="color: #0000BB;">data</span> @ `20250901-150701-9a538a4b` (via latest(parameter:cyl == this:cyl &amp;&amp; name == "data"))</span></span>
<span><span class="co">## &gt; d &lt;- readRDS("data.rds")</span></span>
<span><span class="co">## &gt; png("analysis.png")</span></span>
<span><span class="co">## &gt; plot(mpg ~ disp, d)</span></span>
<span><span class="co">## &gt; dev.off()</span></span>
<span><span class="co">## agg_png </span></span>
<span><span class="co">##       2</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">analysis.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150701-e65b86aa at 2025-09-01 15:07:01.966202 (0.0618875 secs)</span></span>
<span><span class="co">## [1] "20250901-150701-e65b86aa"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="interpreting-errors">Interpreting errors<a class="anchor" aria-label="anchor" href="#interpreting-errors"></a>
</h3>
<p>If your query fails to resolve a candidate it will error:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"analysis"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">9000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">analysis</span>' `20250901-150702-0d34ba80` at 2025-09-01 15:07:02.055987</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Parameters:</span></span>
<span><span class="co">## • cyl: 9000</span></span>
<span><span class="co">## &gt; pars &lt;- orderly2::orderly_parameters(cyl = NULL)</span></span>
<span><span class="co">## &gt; orderly2::orderly_dependency(</span></span>
<span><span class="co">## +   "data",</span></span>
<span><span class="co">## +   "latest(parameter:cyl == this:cyl)",</span></span>
<span><span class="co">## +   "data.rds")</span></span>
<span><span class="co">## <span style="color: #BB0000;">✖</span> Error running <span style="color: #0000BB;">analysis.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150702-0d34ba80 at 2025-09-01 15:07:02.119565 (0.06357765 secs)</span></span>
<span><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `orderly2::orderly_run()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> Failed to run report</span></span>
<span><span class="co">## <span style="font-weight: bold;">Caused by error in `outpack_packet_use_dependency()`:</span></span></span>
<span><span class="co">## <span style="color: #BBBB00;">!</span> Failed to find packet for query 'latest(parameter:cyl == this:cyl &amp;&amp;</span></span>
<span><span class="co">##   name == "data")'</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> See 'rlang::last_error()$explanation' for details</span></span></code></pre></div>
<p>The error message here tries to be fairly self explanatory; we have
failed to find a packet that satisfies our
query<code>latest(parameter:cyl == this:cyl &amp;&amp; name == "data")</code>;
note that the report name <code>data</code> has become part of this
query, so there are two conditions being matched on.</p>
<p>The error suggests running
<code>rlang::last_error()$explanation</code> for more information, which
we can do:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/last_error.html" class="external-link">last_error</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">explanation</span></span>
<span><span class="co">## Evaluated query: 'latest(<span style="font-weight: bold;">A</span> &amp;&amp; <span style="font-weight: bold;">B</span>)' and found 0 packets</span></span>
<span><span class="co">## • <span style="font-weight: bold;">A</span> (parameter:cyl == this:cyl): 0 packets</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## • <span style="font-weight: bold;">B</span> (name == "data"): 3 packets</span></span></code></pre></div>
<p>This is an <code>orderly_query_explain</code> object, which tries to
come up with reasons why your query might not have matched; we’ll expand
this in the future so let us know what you might like to see.</p>
<p>This tells you that your query can be decomposed into two subqueries
<code>A</code> (the match against the parameter <code>cyl</code> being
9000), which matched no packets and <code>B</code> (the match against
the packet name being <code>data</code>), which matched 3 packets. If
each subquery matched packets but some <em>pairs</em> don’t then it will
try and guide you towards problematic pairs.</p>
<p>You can also ask <code>orderly2</code> to explain any query for
you:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_query_explain.html">orderly_query_explain</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">9000</span><span class="op">)</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span><span class="co">## Evaluated query: 'latest(<span style="font-weight: bold;">A</span> &amp;&amp; <span style="font-weight: bold;">B</span>)' and found 0 packets</span></span>
<span><span class="co">## • <span style="font-weight: bold;">A</span> (parameter:cyl == 9000): 0 packets</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## • <span style="font-weight: bold;">B</span> (name == "data"): 3 packets</span></span></code></pre></div>
<p>If you save this object you can explore it in more detail:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">explanation</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_query_explain.html">orderly_query_explain</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">cyl</span> <span class="op">==</span> <span class="fl">9000</span><span class="op">)</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span><span class="va">explanation</span><span class="op">$</span><span class="va">parts</span><span class="op">$</span><span class="va">B</span></span>
<span><span class="co">## $name</span></span>
<span><span class="co">## [1] "B"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $str</span></span>
<span><span class="co">## [1] "name == \"data\""</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $expr</span></span>
<span><span class="co">## name == "data"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $n</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $found</span></span>
<span><span class="co">## [1] "20250901-150701-9a538a4b" "20250901-150701-a8a20cf0"</span></span>
<span><span class="co">## [3] "20250901-150701-b73ff07c"</span></span></code></pre></div>
<p>(this would have worked with
<code>rlang::last_error()$explanation$parts$A</code> too).</p>
<p>You can also use <code><a href="../reference/orderly_metadata_extract.html">orderly2::orderly_metadata_extract</a></code> to
work out what values you might have looked for:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_metadata_extract.html">orderly_metadata_extract</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  extract <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="st">"parameters.cyl is number"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##                         id cyl</span></span>
<span><span class="co">## 1 20250901-150701-9a538a4b   4</span></span>
<span><span class="co">## 2 20250901-150701-a8a20cf0   6</span></span>
<span><span class="co">## 3 20250901-150701-b73ff07c   8</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="filtering-candidates-in-other-ways">Filtering candidates in other ways<a class="anchor" aria-label="anchor" href="#filtering-candidates-in-other-ways"></a>
</h3>
<p>Above we saw two types of filtering candidates: <code>latest()</code>
selected the most recent packet while
<code>latest(parameter:cyl == this:cyl)</code> found a packet whose
parameter matched one of our parameters.</p>
<p>We could have used <code>latest(parameter:cyl == 4)</code> to hard
code in a specific parameter value, and used
<code>latest(parameter:cyl == environment:cyl)</code> to match against
whatever value <code>cyl</code> took in the evaluating environment.</p>
<p>Instead of a query, you can provide a single id (e.g,
<code>20250901-150701-e65b86aa</code>), which would mean that even as
new copies of the <code>data</code> packet are created, this dependency
will always resolve to the same value.</p>
<p>You can chain together logical operations with
<code>&amp;&amp;</code> (both sides must be true) or <code>||</code>
(either side must be true), and group conditions with parentheses. In
addition to <code>==</code>, the usual complement of comparison
operators will work. So you might have complex queries like</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">latest</span><span class="op">(</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">x</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">||</span> <span class="va">parameter</span><span class="op">:</span><span class="va">x</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">parameter</span><span class="op">:</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>but in practice most people have queries that are a series of
restrictions with <code>&amp;&amp;</code>.</p>
<!-- not implemented yet:

  filter by time, perhaps

  latest(created() > 2022-01-01)

  (but this might be better in the search options I think)

  filter by having a file:

  has_file("results/data.rds")

    -->
</div>
<div class="section level3">
<h3 id="computing-dependencies-and-using-many-dependencies-at-once">Computing dependencies and using many dependencies at once<a class="anchor" aria-label="anchor" href="#computing-dependencies-and-using-many-dependencies-at-once"></a>
</h3>
<p>One common pattern is the map-reduce pattern over a set of orderly
reports. With this, a set of packets are created over a vector of
parameters, or perhaps a chain of different reports for each parameter,
then they are all combined together. For some parameter <code>p</code>
that takes values “x”, “y” and “z”, this might look like:</p>
<pre><code>    B(p = "x") -- C(p = "x")
  /                          \
A - B(p = "y") -- C(p = "y") - D
  \                          /
    B(p = "z") -- C(p = "z")</code></pre>
<p>So here, D will want to combine all of the three copies of the
<code>C</code> packet, one for each of <code>p</code> as “x”, “y” and
“z”.</p>
<p>Especially if there are only three values and these are hard coded,
you might just write it out as</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">p</span> <span class="op">==</span> <span class="st">"x"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data/x.rds"</span> <span class="op">=</span> <span class="st">"result.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">p</span> <span class="op">==</span> <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data/y.rds"</span> <span class="op">=</span> <span class="st">"result.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">p</span> <span class="op">==</span> <span class="st">"z"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data/z.rds"</span> <span class="op">=</span> <span class="st">"result.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note here that in each call we vary the second argument to select a
different parameter value, and in the third argument we are naming our
destination file a different name (so we end up with three files in
<code>data/</code>).</p>
<p>You can write this out as a <code>for</code> loop:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">p</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span><span class="st">"C"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">latest</span><span class="op">(</span><span class="va">parameter</span><span class="op">:</span><span class="va">p</span> <span class="op">==</span> <span class="va">environment</span><span class="op">:</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data/${p}.rds"</span> <span class="op">=</span> <span class="st">"result.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, in the second argument we use <code>environment:p</code> to
fetch the value of <code>p</code> from the calling environment - this is
the looping value so will take all three values. In the name of the
third argument, we use the special interpolation format
<code>${p}</code> to substitute in the value of <code>p</code> to build
a filename.</p>
</div>
</div>
<div class="section level2">
<h2 id="how-dependencies-interact-with-locations">How dependencies interact with locations<a class="anchor" aria-label="anchor" href="#how-dependencies-interact-with-locations"></a>
</h2>
<p>By default, any packet that you have unpacked on your local archive
is considered a candidate for inclusion by
<code><a href="../reference/orderly_dependency.html">orderly_dependency()</a></code>. This is not always what you want.</p>
<p>The locations that are selected, and the packets within them that are
considered as candidates can be controlled by the
<code>search_options</code> argument to
<code><a href="../reference/orderly_run.html">orderly2::orderly_run</a></code> (note that the argument is to
<code><a href="../reference/orderly_run.html">orderly_run()</a></code>, not to <code><a href="../reference/orderly_dependency.html">orderly_dependency()</a></code>
because this is an effect controlled by the <em>runner</em> of the
report, not the <em>writer</em> of the report).</p>
<p>There are three components here that affect how packets are
selected</p>
<ul>
<li>
<code>location</code>: is a character vector of locations, matching
your location names. Only packets that can be found at these locations
will be considered. So if you have a mix of locally created packets as
well as ones that other people can see, specifying
<code>location = "server"</code> would limit to packets that are
available on the server, which means that you will end up with
dependencies that you colleagues would also get.</li>
<li>
<code>allow_remote</code>: controls if we are willing to download
files from a location in order to satisfy a dependency. If
<code>TRUE</code>, then when you run the report, it might download files
if more recent packets are available on a location than what you have
locally.</li>
<li>
<code>fetch_metadata</code>: only has an effect if
<code>allow_remote</code> is also <code>TRUE</code>; this causes the
metadata to be refreshed before dependency resolution.</li>
</ul>
<p>There is further discussion of the details in
<code><a href="../reference/orderly_run.html">?orderly_run</a></code></p>
<!-- # Working out why a candidate cannot be found -->
</div>
<div class="section level2">
<h2 id="other-points">Other points<a class="anchor" aria-label="anchor" href="#other-points"></a>
</h2>
<p>If you are used to systems like <code>targets</code>, it is easy to
make reports smaller than they need to be. There’s on real need to make
these very small, and picking the right size is a challenge.</p>
<p>If they are too small, you’ll end up writing a lot of code to
orchestrate running different reports and pulling things together.
You’ll end spending a lot of time about whether things are “up to date”
with one another because really a group of things always wants to run
together.</p>
<p>If they’re too big then you might end up doing more work than you
want to do, because in order to make a change to part of a piece of
analysis you must run the whole thing again.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Robert Ashton, Martin Eden, Alex Hill, Wes Hinsley, Mantra Kusumgar, Paul Liétar, James Thompson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
