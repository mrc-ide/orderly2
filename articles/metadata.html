<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Outpack metadata • orderly2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Outpack metadata">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">orderly2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.99.81</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/orderly2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction to orderly2</a></li>
    <li><a class="dropdown-item" href="../articles/dependencies.html">Dependencies between packets</a></li>
    <li><a class="dropdown-item" href="../articles/collaboration.html">Collaborative analysis</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from orderly (1.x)</a></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Outpack metadata</a></li>
    <li><a class="dropdown-item" href="../articles/query.html">Orderly query DSL</a></li>
    <li><a class="dropdown-item" href="../articles/plugins.html">Creating plugins</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/orderly2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Outpack metadata</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/orderly2/blob/main/vignettes/metadata.Rmd" class="external-link"><code>vignettes/metadata.Rmd</code></a></small>
      <div class="d-none name"><code>metadata.Rmd</code></div>
    </div>

    
    
<p>The <code>orderly2</code> package is the reference implementation at
the moment of the outpack specification; a collection of schemas and
directory structures that outpack requires. Once we release (or possibly
before), we will split this specification from the package, though the
package will continue to bundle a copy.</p>
<p>We make use of <a href="https://json-schema.org" class="external-link">JSON schema</a> to
document the schemas used.</p>
<p>This vignette outlines the basic structure of files within the
<code>.outpack/</code> directories, and is not itself an overview of how
outpack works; the primary audience is people working on outpack itself
(though a small introduction is provided below).</p>
<div class="section level2">
<h2 id="basic-overview">Basic overview<a class="anchor" aria-label="anchor" href="#basic-overview"></a>
</h2>
<p>Each “packet” is conceptually a directory, corresponding to a
particular analysis or data product, though this is not necessarily how
it is stored. The internal representation includes:</p>
<ul>
<li>metadata about the packet - which files it contains and their hashes
along with information about what was done to create it and the
environment it was created in etc (see below)</li>
<li>actual file contents of every included file. This might be stored in
a simple content-addressable file storage system (see below) or actual
copies of the directories as originally created</li>
</ul>
<p>Every packet is referenced uniquely by a primary key. We use a key
format that encodes the current date and time, as well as random data to
avoid collisions.</p>
<p>There exists some dependency graph among packets, as one packet
depends on another. Each edge of this graph has a hard link (from one
packet to another by an id) and also a query (e.g., latest packet with
some name) which was used to find the packet. This means that there are
many ways of looking at or thinking about the dependency graph.</p>
<p>Not all packets are available locally, some are on other outpack
repositories, typically (but not always) on other machines and accessed
over an HTTP API. These are conceptually similar to git “remotes”.</p>
<p>We will need to distinguish between packets which are “unpacked”
(that is, packets with every file available in the current archive) and
packets that are merely known about (those for which we have the
metadata but not the files). We will sometimes refer to these unpacked
packets as “local” as they are known to the “local” location which is
special.</p>
<p><em>We use the terms “archive” and “repository” fairly
interchangeably below and will try and nail that down.</em></p>
</div>
<div class="section level2">
<h2 id="what-goes-into-a-packet">What goes into a packet<a class="anchor" aria-label="anchor" href="#what-goes-into-a-packet"></a>
</h2>
<p>Each packet must have a few things:</p>
<ul>
<li>a name (for example <code>model_fits</code>). This cannot be changed
(or rather changes cannot be tracked) and there is not currently a way
of namespacing this between different repositories</li>
<li>an id (see “outpack id” below) which is created by outpack at the
point where the packet is started</li>
<li>a set of parameters - this is a mapping between strings and some
scalar type (boolean, number, string). Packets may have zero to many
parameters.</li>
<li>a set of files - these have a local (relative) path within a packet
(e.g., <code>output/data.csv</code>) and also a hash (e.g.,
<code>sha256:69f6cf230416cf40828da251a0dad17cbbf078587883e826f3345ff08d1aaa7d</code>)</li>
<li>Information about when the packet was run (start and end time), each
represented in seconds post epoch, UTC (see below).</li>
</ul>
<p>In addition it may contain information about:</p>
<ul>
<li>dependencies that it used, tracking the name of the included packet,
the query used to find it, the resolved id, and the set of files
extracted from that packet (source name, hash and destination name)</li>
<li>the names of scripts that were run to create the packet (typically
also included as files within the final packet)</li>
<li>information about state of git at the point where the packet was run
(current branch, hash, etc)</li>
<li>information about the system used to run the packet (format
unspecified but might include hostname, operating system version,
package/module versions, etc)</li>
<li>custom metadata added by the implementation</li>
</ul>
</div>
<div class="section level2">
<h2 id="types-of-users-of-outpack">Types of users of outpack<a class="anchor" aria-label="anchor" href="#types-of-users-of-outpack"></a>
</h2>
<p>There are a few types of “persona” of outpack user that we imagine
exist and which guide some decisions abut layout below. At the extremes
we have:</p>
<ul>
<li>a user on a desktop who wants to develop or run some analyses, using
files present in packets available on some server. They will want to
visually inspect the results of running their packets, so need to see
files on disk in a way that makes sense to a human, but they do not care
about having a complete copy of all dependencies down the graph.</li>
<li>a server instance which is responsible for delivering packets to
users (e.g., the persona above). They are expected to have (or be able
to fetch) any part of the outpack graph, but we do not expect that
anyone will want to visually inspect the packets directly on this
machine (that is, the storage does not need to be human-readable).</li>
</ul>
<p>This impacts two configuration options and associated parts of the
directory structure below:</p>
<ul>
<li>Does the user use the content-addressable “file store” or
human-readable “archive” (explained in detail below)</li>
<li>Do we require that the archive contains a complete tree of all
dependencies?</li>
</ul>
<p>We expect the first persona wants the human readable archive and not
to contain a full tree, while the second wants the opposite.</p>
</div>
<div class="section level2">
<h2 id="directory-layout">Directory layout<a class="anchor" aria-label="anchor" href="#directory-layout"></a>
</h2>
<p>This section discusses the files and directory that make outpack
work, but not so much how these come to be; see below for that.</p>
<p>A typical <code>.outpack</code> directory layout looks like this:</p>
<pre><code>.outpack/
  config.json
  files/
  location/
  metadata/
archive/</code></pre>
<p>(note that <code>archive/</code> and <code>.outpack</code> here are
at the same level). Not all of these directories will necessarily be
present; indeed the only required file is
<code>.outpack/config.json</code>.</p>
<div class="section level3">
<h3 id="configuration--outpackconfig-json">Configuration (<code>.outpack/config.json</code>)<a class="anchor" aria-label="anchor" href="#configuration--outpackconfig-json"></a>
</h3>
<p>The outpack configuration schema is defined in <a href="https://github.com/mrc-ide/orderly2/blob/main/inst/schema/outpack/config.json" class="external-link"><code>config.json</code></a></p>
<p>The configuration format is still subject to change…</p>
</div>
<div class="section level3">
<h3 id="packet-metadata--outpackmetadata">Packet metadata (<code>.outpack/metadata/</code>)<a class="anchor" aria-label="anchor" href="#packet-metadata--outpackmetadata"></a>
</h3>
<p>Each file within this directory has a filename that is an outpack id
(matching the regular expression
<code>^[0-9]{8}-[0-9]{6}-[0-9a-f]{8}$</code>, see below. Each file is a
json file conforming to the schema <a href="https://github.com/mrc-ide/orderly2/blob/main/inst/schema/outpack/metadata.json" class="external-link"><code>metadata.json</code></a>.</p>
<p>Being present here means that an outpack implementation can report
information back about a packet (when it was created, what files it
contains, etc), but packet metadata are not very meaningful on their
own; we want to know where they might have come from (a location that is
distributing this packet) and if we have a copy of the packet
locally.</p>
</div>
<div class="section level3">
<h3 id="location-information--outpacklocation">Location information (<code>.outpack/location/</code>)<a class="anchor" aria-label="anchor" href="#location-information--outpacklocation"></a>
</h3>
<p>This directory matches the regular expression <code>^[0-9]{8}$</code>
(e.g., <code>457f4f2a</code>) and is a “location id” (see below)
corresponding to a “location”. Each file within this directory has an
outpack id as name, and contains json about when that location unpacked
(or installed) the packet, and the hash of the metadata. This file
conforms to the schema <a href="https://github.com/mrc-ide/orderly2/blob/main/inst/schema/outpack/location.json" class="external-link"><code>location.json</code></a>.</p>
</div>
<div class="section level3">
<h3 id="a-file-store--outpackfiles">A file store (<code>.outpack/files</code>)<a class="anchor" aria-label="anchor" href="#a-file-store--outpackfiles"></a>
</h3>
<p>If the configuration option <code>core.use_file_store</code> is
<code>true</code>, then outpack keeps a content addressable file store
of all files that it knows about. This is much more space efficient than
having the entire packet unpacked as it automatically deduplicates
shared content among packets (e.g., if a large file is present in two
packets it will only be stored once). The file store layout is described
below.</p>
<p>This storage format is not human-readable (and indeed present only
within the hidden directory <code>.outpack</code>). It can be enabled on
either server or user</p>
</div>
<div class="section level3">
<h3 id="an-archive-archive-by-default">An archive (<code>archive/</code> by default)<a class="anchor" aria-label="anchor" href="#an-archive-archive-by-default"></a>
</h3>
<p>If the configuration option <code>core.path_archive</code> is
non-<code>null</code> then there will be a directory with that path
containing unpacked packets. Each packet will be available at the
path</p>
<pre><code>archive/&lt;name&gt;/&lt;id&gt;/&lt;files...&gt;</code></pre>
<p>With <code>&lt;name&gt;</code> being the “name” of the packet,
<code>&lt;id&gt;</code> being its outpack id. There will be several
files per packet, possibly themselves in directories. This storage
approach is designed to be human readable, and will typically only be
enabled where the outpack repository is being used on a laptop where a
user wants to interactively work with files.</p>
</div>
</div>
<div class="section level2">
<h2 id="adding-a-packet">Adding a packet<a class="anchor" aria-label="anchor" href="#adding-a-packet"></a>
</h2>
<p>In order to make a packet available locally, you need to import the
metadata and the files, then mark the packet as available. This will be
roughly the same if you are creating a packet (i.e., you are the first
place where a packet has ever existed) or if you are importing a packet
from elsewhere.</p>
<p>Making the packet available allows it to be used as a dependency,
allows serving that packet if you are acting as a location (over the
http or file protocols), and guarantees that the files are actually
present locally.</p>
<div class="section level3">
<h3 id="adding-metadata">Adding metadata<a class="anchor" aria-label="anchor" href="#adding-metadata"></a>
</h3>
<p>You can simply copy metadata as the file
<code>.outpack/metadata/&lt;packet id&gt;</code> if it does not yet
exist. This does not make it available to anything yet as it is not
known from any location. Dangling metadata (that is, metadata present in
this directory but not known anywhere) is currently mostly ignored.</p>
</div>
<div class="section level3">
<h3 id="adding-files">Adding files<a class="anchor" aria-label="anchor" href="#adding-files"></a>
</h3>
<p>If the repository uses a file store, you should fill this first,
because it is much easier to think about. You can easily get the
difference between files used by a packet (the list of files in the
packet manifest) and what you already have in the file store by looking
up each hash in turn. You should then request and missing files and
insert them into the store. This may leave “dangling” files for a while
(files referred to by no packet) but that is not a problem.</p>
<p>If the repository has a human-readable archive <strong>and</strong>
uses a file store, then after the files are all present in the file
store it is easy enough to check them out of the file store to the
requested path (the local relative path in the packet manifest). Because
you update the file store first, all files are guaranteed to be
present.</p>
<p>If the repository <strong>only</strong> uses a human readable
archive, the simplest thing is to request each file from the remote.
However, it might be more efficient to check locally for any previously
fetched copies of files with the same content, verify that they have not
been modified, and then copy those into place rather than
re-downloading.</p>
</div>
<div class="section level3">
<h3 id="marking-the-packet-as-unpacked-and-known-locally">Marking the packet as unpacked and known locally<a class="anchor" aria-label="anchor" href="#marking-the-packet-as-unpacked-and-known-locally"></a>
</h3>
<p>For your local location id, write out a file</p>
<pre><code>.outpack/&lt;local location id&gt;/&lt;packet id&gt;</code></pre>
<p>conforming to the <a href="https://github.com/mrc-ide/orderly2/blob/main/inst/schema/outpack/location.json" class="external-link"><code>location.json</code></a>
schema, and containing the packet id, the time that it was marked as
unpacked and the hash of the metadata.</p>
</div>
<div class="section level3">
<h3 id="ordering-of-operations">Ordering of operations<a class="anchor" aria-label="anchor" href="#ordering-of-operations"></a>
</h3>
<p>We only need both files and metadata once the packet is marked as
unpacked; note that some configurations guarantee that every packet is
unpacked in a complete tree.</p>
<p>You can import files first, or metadata; there is not a lot of
disadvantage to either. You should only mark a package unpacked and
known locally though once both components are present.</p>
</div>
</div>
<div class="section level2">
<h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h2>
<div class="section level3">
<h3 id="outpack-ids">Outpack ids<a class="anchor" aria-label="anchor" href="#outpack-ids"></a>
</h3>
<p>Outpack ids match the regular expression
<code>^[0-9]{8}-[0-9]{6}-[0-9a-f]{8}$</code>; they are encode UTC
date-time as with the prefix <code>YYYYMMDD-HHMMSS-</code> and are
followed by 8 hexadecimal digits. In the R implementation, we encode the
current second as the first four digits (2 bytes) and append 2 bytes of
cryptographically random data.</p>
<p>The id tries to balance a reasonable degree of collision resistance
(65536 combinations per millisecond), lexicographic sortability and a
reasonable degree of meaningfulness.</p>
</div>
<div class="section level3">
<h3 id="location-ids">Location ids<a class="anchor" aria-label="anchor" href="#location-ids"></a>
</h3>
<p>Location ids are meaningless 4-byte (8 character) hex strings. They
are immutable once created and are different between different machines
even if they point to the same location. This location id is then mapped
(via <code>.outpack/config.json</code>) to a location <em>name</em>
which is a human-readable name (e.g., <code>production</code> or
<code>staging</code>). There is no requirement that this name is the
same for different machines.</p>
<p>One of these directories represents the local location; you can find
that mapping within the configuration.</p>
</div>
<div class="section level3">
<h3 id="representing-hashes">Representing hashes<a class="anchor" aria-label="anchor" href="#representing-hashes"></a>
</h3>
<p>Outpack typically uses <code>sha256</code> hashes, but we want to be
able to change this in future. So wherever a hash is presented, the
algorithm is included as part of the string. For example</p>
<pre><code>sha256:69f6cf230416cf40828da251a0dad17cbbf078587883e826f3345ff08d1aaa7d</code></pre>
<p>If we had instead used the md5 algorithm we would have written</p>
<pre><code><span><span class="va">md5</span><span class="op">:</span><span class="va">bd57f7123c6bfb95c3234ff56373b7f4</span></span></code></pre>
<p>The schema currently assumes that the hash value is represented as a
hex string.</p>
</div>
<div class="section level3">
<h3 id="times">Times<a class="anchor" aria-label="anchor" href="#times"></a>
</h3>
<p>We store information about times in a few places (e.g., times that a
packet was run, imported, etc). Rather than trying to deal with strings,
we always store time in seconds since
<code>1970-01-01 00:00.00 UTC</code> (including fractional seconds, to
whatever accuracy your system allows).</p>
</div>
<div class="section level3">
<h3 id="file-store">File store<a class="anchor" aria-label="anchor" href="#file-store"></a>
</h3>
<p>The file store is designed to be simple, and is not as sophisticated
as that in git, whose object store does a similar thing.</p>
<p>The general layout looks like:</p>
<pre><code>.outpack/files
  sha256/
    5d/
      dfaf1f4a2e15e8fe46dbed145bf2f84bba1b3367d0a56f73de08f8585dd153
      ...
    77/
    ...</code></pre>
<p>With hopefully a fairly obvious structure. Paths have format:</p>
<pre><code>&lt;algorithm&gt;/&lt;first two bytes&gt;/&lt;remaining bytes&gt;</code></pre>
<p>The reason for the second level is to prevent performance degradation
with directories containing millions of files, again copying git.</p>
<p>The store is designed to cope with different hashing algorithms,
though the R implementation of <code>outpack</code> only supports
<code>sha256</code> for now.</p>
<p>Multiple hashing algorithms could be supported by hard linking
content into multiple places with in the tree, so we might link</p>
<pre><code>sha256/5d/dfaf1f4a2e15e8fe46dbed145bf2f84bba1b3367d0a56f73de08f8585dd153</code></pre>
<p>as</p>
<pre><code>md5/84/0bc6ad3ae479dccc1c49a1910b37bd</code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Robert Ashton, Martin Eden, Alex Hill, Wes Hinsley, Mantra Kusumgar, Paul Liétar, James Thompson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
