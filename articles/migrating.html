<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Migrating from orderly (1.x) • orderly2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Migrating from orderly (1.x)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">orderly2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.99.81</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/orderly2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction to orderly2</a></li>
    <li><a class="dropdown-item" href="../articles/dependencies.html">Dependencies between packets</a></li>
    <li><a class="dropdown-item" href="../articles/collaboration.html">Collaborative analysis</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from orderly (1.x)</a></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Outpack metadata</a></li>
    <li><a class="dropdown-item" href="../articles/query.html">Orderly query DSL</a></li>
    <li><a class="dropdown-item" href="../articles/plugins.html">Creating plugins</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/orderly2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Migrating from orderly (1.x)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/orderly2/blob/main/vignettes/migrating.Rmd" class="external-link"><code>vignettes/migrating.Rmd</code></a></small>
      <div class="d-none name"><code>migrating.Rmd</code></div>
    </div>

    
    
<p>The new version of orderly (codename <code>orderly2</code> for now)
is very different to the previously released version on CRAN (orderly
1.4.3; September 2021) or the last development version of the 1.x line
(orderly 1.6.x; June 2023). These changes constitute a ground-up rewrite
in order to bring out the best features we found that orderly enabled
within workflows, while removing some features we felt have outlived
their usefulness. This is disruptive change, but we hope that it will be
worth it.</p>
<p>This vignette is divided into two parts; one covers the conceptual
differences between <code>orderly1</code> and <code>orderly2</code>
while the second covers the mechanical process of migrating from an
existing orderly source tree and archive to take advantage of the new
features.</p>
<p>If you have never used version 1.x of orderly, you should not read
this document unless you are curious about the history of design
decisions. Instead you should read the introductory vignette
(<code><a href="../articles/orderly2.html">vignette("orderly2")</a></code>).</p>
<div class="section level2">
<h2 id="summary-of-changes">Summary of changes<a class="anchor" aria-label="anchor" href="#summary-of-changes"></a>
</h2>
<div class="section level3">
<h3 id="so-long-yaml-and-thanks-for-all-the-whitespace-errors">So long YAML and thanks for all the whitespace errors<a class="anchor" aria-label="anchor" href="#so-long-yaml-and-thanks-for-all-the-whitespace-errors"></a>
</h3>
<p>The most obvious user-facing change is that there is (almost) no <a href="https://en.wikipedia.org/wiki/YAML" class="external-link">YAML</a>, with the definition
of inputs and outputs for a report now defined within an orderly file,
<code>&lt;reportname&gt;.R</code>. So an orderly report that previously
had an <code>orderly.yml</code> file that looked like</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">parameters</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="at">  </span><span class="fu">n_min</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="at">    </span><span class="fu">default</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">script</span><span class="kw">:</span><span class="at"> script.R</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">source</span><span class="kw">:</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> functions.R</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> metadata.csv</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">depends</span><span class="kw">:</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="at">  </span><span class="fu">raw_data</span><span class="kw">:</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="at">    </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="at">    </span><span class="fu">use</span><span class="kw">:</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="at">      </span><span class="fu">raw_data.csv</span><span class="kw">:</span><span class="at"> data.csv</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="fu">artefacts</span><span class="kw">:</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="at">  </span><span class="fu">data</span><span class="kw">:</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="at">    </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Processed data</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="at">    </span><span class="fu">filenames</span><span class="kw">:</span><span class="at"> data.rds</span></span></code></pre></div>
<p>would end up within an orderly file that looks like:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_parameters.html">orderly_parameters</a></span><span class="op">(</span>n_min <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_dependency.html">orderly_dependency</a></span><span class="op">(</span><span class="st">"raw_data"</span>, <span class="st">"latest"</span>, </span>
<span>                             files <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"raw_data.csv"</span> <span class="op">=</span> <span class="st">"data.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_resource.html">orderly_resource</a></span><span class="op">(</span><span class="st">"metadata.csv"</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_artefact.html">orderly_artefact</a></span><span class="op">(</span>description <span class="op">=</span> <span class="st">"Processed data"</span>, <span class="st">"data.rds"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"functions.R"</span><span class="op">)</span></span></code></pre></div>
<p>We think this is much clearer, and comes with documentation and
autocomplete support in most IDEs.</p>
<p>In fact, for simple reports, <strong>no</strong> special functions
are required, though you’ll find that some will be useful (see
<code><a href="../articles/orderly2.html">vignette("orderly2")</a></code>)</p>
<p>Some specific changes:</p>
<ul>
<li>you no longer need to list packages with <code>packages:</code>,
instead just use <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code> as in an ordinary script. We
will record the state of the session regardless so you will get a record
of what was used</li>
<li>you no longer need to use <code>sources:</code> to list scripts you
want to source, instead use <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code> as normal</li>
<li>
<code>global_resources</code> has become
<code><a href="../reference/orderly_shared_resource.html">orderly2::orderly_shared_resource</a></code> (these aren’t really
global so much as shared). Note that the directory they are in is now
always <code>shared/</code> at the orderly root, you may not configure
it.</li>
</ul>
<div class="section level4">
<h4 id="implications">Implications<a class="anchor" aria-label="anchor" href="#implications"></a>
</h4>
<p>This change has widespread implications:</p>
<ul>
<li>you can program against things like dependencies, creating a
<code>for</code> loop over a series of parameter values, or
conditionally depending on other reports</li>
<li>any R script can be the basis of an orderly report, and you can add
orderly functions annotating inputs and outputs progressively</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="database-support-has-been-moved-into-a-plugin">Database support has been moved into a plugin<a class="anchor" aria-label="anchor" href="#database-support-has-been-moved-into-a-plugin"></a>
</h3>
<p>In version 1, we had built-in support for accessing data from SQL
databases; this has moved within the <a href="https://github.com/mrc-ide/orderly.db" class="external-link"><code>orderly.db</code></a>
plugin. All major features are supported.</p>
</div>
<div class="section level3">
<h3 id="no-more-commit">No more commit<a class="anchor" aria-label="anchor" href="#no-more-commit"></a>
</h3>
<p><code>orderly2</code> no longer requires a separate
<code>orderly_commit()</code> call after <code><a href="../reference/orderly_run.html">orderly_run()</a></code>; we
no longer make a distinction between local draft and archive packets.
Instead, we have added finer-grained control over where dependencies are
resolved from (locally, or from some subset of your servers), which
generalises the way that draft/archive was used in practice. See
<code><a href="../reference/orderly_run.html">?orderly_run</a></code> for more details on how dependencies are
resolved.</p>
<p>This has implications for deleting things; the draft directory was
always an easy target for deletion, but now after deletion you will need
to tell <code>orderly2</code> that you have deleted things. See
<code><a href="../articles/introduction.html">vignette("introduction")</a></code> for details on this (section
“Deleting things from the archive”).</p>
</div>
<div class="section level3">
<h3 id="no-more-testing-or-development-mode">No more testing or development mode<a class="anchor" aria-label="anchor" href="#no-more-testing-or-development-mode"></a>
</h3>
<p>We have had two different, but unsatisfactory, mechanisms for
developing an orderly report:</p>
<ul>
<li>
<code>orderly_test_start</code> (up to version 1.1.0)</li>
<li>
<code>orderly_develop_start</code> (from 1.1.0 onwards)</li>
</ul>
<p>These worked by doing the initial setup, and copying of dependencies
etc to a location you could work (a new draft for
<code>orderly_test_start</code> and the source directory for
<code>orderly_develop_start</code>). From <code>orderly2</code> you can
just work directly within the source directory, and so long as your
working directory is set to <code>src/&lt;report-name&gt;</code>, all
<code>orderly2</code> commands will work as expected.</p>
<p>As with <code>orderly1</code>, you will need to be careful not to
commit (to git) results of running your analysis, and we encourage
per-report <code>.gitignore</code> files to help with this.</p>
</div>
<div class="section level3">
<h3 id="new-language-agnostic-backend">New, language-agnostic, backend<a class="anchor" aria-label="anchor" href="#new-language-agnostic-backend"></a>
</h3>
<p>The biggest change, but perhaps the least visible, is that orderly is
now built on an open spec <a href="https://github.com/mrc-ide/outpack" class="external-link">outpack</a> which can be
implemented for any language. We will develop a Python implementation of
this, and possibly other languages.</p>
<p>This takes control of all the metadata. As such there is a split
between “<code>orderly_</code>” and “<code>outpack_</code>” functions in
this package, for more information see the last section of
<code><a href="../articles/introduction.html">vignette("introduction")</a></code> and also
<code>vignette("outpack")</code>.</p>
</div>
<div class="section level3">
<h3 id="other-smaller-changes">Other, smaller changes<a class="anchor" aria-label="anchor" href="#other-smaller-changes"></a>
</h3>
<p><strong>“Global” resources have become “shared” resources</strong>,
and always live in <code>shared/</code> at the orderly root (i.e., this
is no longer configurable). The reason for this is that we want reports
to be able to be run fairly independently of the <code>orderly2</code>
configuration (the only exception to this are plugins). In practice
people did not really vary this.</p>
<p><strong>You can depend on anything</strong>; if a packet has produced
a file you can depend on it, regardless of if it was an artefact, a
resource or simply just present.</p>
</div>
</div>
<div class="section level2">
<h2 id="what-is-missing-compared-with-orderly1">What is missing compared with <code>orderly1</code><a class="anchor" aria-label="anchor" href="#what-is-missing-compared-with-orderly1"></a>
</h2>
<ul>
<li>the changelog feature (we may implement something to support
this)</li>
<li>extraction of secrets from vault (we may support this)</li>
<li>automatic handling of README files (we may implement support for
this)</li>
</ul>
</div>
<div class="section level2">
<h2 id="how-to-migrate">How to migrate<a class="anchor" aria-label="anchor" href="#how-to-migrate"></a>
</h2>
<p>There are two parts to a migration: updating the canonical copy of
your orderly archive (ideally you only have one of these) and updating
your source tree. These steps should be done via the <a href="https://github.com/mrc-ide/outpack.orderly" class="external-link"><code>outpack.orderly</code></a>
package.</p>
<p>You should migrate your archive first. Do this for every archive that
you want to retain (you might have archives stored locally, on
production servers and on staging servers). Archive migration happens
<em>out of place</em>; that is, we do not modify anything in the
original location. If your archive is old and has been used with very
old versions of <code>orderly1</code> it is possible that this process
will have a few hiccups. Please let us know if that is the case. The
result of this process is that you will end up with a new directory that
contains a new archive conforming to the <code>outpack</code> spec and
containing <code>orderly2</code> metadata.</p>
<p>Next, migrate your source tree. This will be done <em>in place</em>
so should be done on a fresh clone of your source git repository. For
each report, we will examine your <code>orderly.yml</code> files and
your script files (often <code>script.R</code>), delete these, and then
write out a new orderly file that will adapt your report to work for
<code>orderly2</code>. It is possible that this will not be perfect and
might need some minor tweaking but hopefully it will be reasonable. One
thing that is not preserved (and we probably cannot do so) is the
comments from the <code>yaml</code> but as these often refer to
<code>yaml</code> formatting or <code>orderly1</code> features hopefully
this is not too much of a problem. You will probably want to manually
tweak the generated code anyway, to take advantage of some of the new
<code>orderly2</code> features such as being able to compute
dependencies.</p>
<p>If you are using OrderlyWeb, you probably need to pause before
migrating, as the replacement is not yet ready.</p>
</div>
<div class="section level2">
<h2 id="what-about-the-packages">What about the packages?<a class="anchor" aria-label="anchor" href="#what-about-the-packages"></a>
</h2>
<p>We will merge <code>orderly2</code> into the <code>orderly</code>
package, so once we are ready for release you can use that. However, we
anticipate a period of coexistence of both legacy <code>orderly1</code>
systems while we develop <code>orderly2</code>. To help with this we
have a small helper package <a href="https://mrc-ide.github.io/orderly.helper" class="external-link"><code>orderly.helper</code></a>
which can smooth over these namespace differences; this may be useful if
you interact with both versions.</p>
</div>
<div class="section level2">
<h2 id="what-were-the-problems-in-version-1">What were the problems in version 1<a class="anchor" aria-label="anchor" href="#what-were-the-problems-in-version-1"></a>
</h2>
<ul>
<li>The YAML format is inflexible, error prone for users, and leads to
duplication</li>
<li>It was too focussed around our initial needs with the <a href="https://vaccineimpact.org" class="external-link">Vaccine Impact Modelling
Consortium</a>
</li>
<li>It was fairly easy to get your archive and SQLite database into an
inconsistent state (e.g., by deleting or moving files from the
archive)</li>
<li>The SQLite database behaved poorly on shared file systems</li>
</ul>
</div>
<div class="section level2">
<h2 id="working-with-old-versions-without-migrating">Working with old versions without migrating<a class="anchor" aria-label="anchor" href="#working-with-old-versions-without-migrating"></a>
</h2>
<p>Sometimes, you will want to use the old version of orderly without
migrating any source, for example to rerun something as it was run in
2020. You can do this by installing <code>orderly1</code>, which can be
safely installed alongside <code>orderly2</code>. You should, however,
avoid loading both packages at once (i.e., with <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code>)
as this will cause ambiguity in a number of functions, notably
<code><a href="../reference/orderly_run.html">orderly_run()</a></code></p>
<p>Install <code>orderly1</code> with:</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span></span>
<span>  <span class="st">"orderly1"</span>,</span>
<span>  repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"https://vimc.r-universe.dev"</span>, <span class="st">"https://cloud.r-project.org"</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>and you can work with the sources or outputs as you wish. You will
need to replace any namespaced calls <code>orderly::fn</code> with
<code>orderly1::fn</code> (these might appear in your documentation,
helper scripts, or similar).</p>
<p>If you try to use <code>orderly2</code> with version 1 sources, then
you will get an error message that will direct you to this document to
decide the best way forward.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Robert Ashton, Martin Eden, Alex Hill, Wes Hinsley, Mantra Kusumgar, Paul Liétar, James Thompson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
