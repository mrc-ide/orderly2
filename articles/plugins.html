<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating plugins • orderly2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating plugins">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">orderly2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.99.81</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/orderly2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction to orderly2</a></li>
    <li><a class="dropdown-item" href="../articles/dependencies.html">Dependencies between packets</a></li>
    <li><a class="dropdown-item" href="../articles/collaboration.html">Collaborative analysis</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced topics</h6></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from orderly (1.x)</a></li>
    <li><a class="dropdown-item" href="../articles/metadata.html">Outpack metadata</a></li>
    <li><a class="dropdown-item" href="../articles/query.html">Orderly query DSL</a></li>
    <li><a class="dropdown-item" href="../articles/plugins.html">Creating plugins</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/orderly2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Creating plugins</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/orderly2/blob/main/vignettes/plugins.Rmd" class="external-link"><code>vignettes/plugins.Rmd</code></a></small>
      <div class="d-none name"><code>plugins.Rmd</code></div>
    </div>

    
    
<p><strong>You may not need to read this: the intended readers are
authors of <code>orderly2</code> plugins, not users of such
plugins.</strong></p>
<p>In order to make <code>orderly2</code> more extensible without
bloating the core, we have designed a simple plugin interface. Our first
use case for this is shifting all of <code>orderly1</code>’s database
functionality out of the main package, but other uses are possible!</p>
<p>This vignette is intended to primarily serve as a design document,
and will be of interest to the small number of people who might want to
write a new plugin, or to edit an existing one.</p>
<div class="section level3">
<h3 id="the-basic-idea">The basic idea<a class="anchor" aria-label="anchor" href="#the-basic-idea"></a>
</h3>
<p>A plugin is provided by a package, possibly it will be the only thing
that a package provides. The plugin name must (currently) be the same as
the package name. The only functions that the package needs to call are
<code>orderly2::orderly_plugin</code> and
<code><a href="../reference/orderly_plugin_register.html">orderly2::orderly_plugin_register</a></code> which create and register
the plugin, respectively.</p>
<p>To make a plugin available for an orderly project, two new bits of
configuration may be present in <code>orderly_config.yml</code> - one
declares the plugin will be used, the other configures the plugin.</p>
<p>To use a plugin for an individual report, functions from the plugin
should be used, which configure and use the plugin.</p>
<p>Finally, we can save information back into the final
<code>orderly2</code> metadata about what the plugin did.</p>
<p>With the yaml-less design of <code>orderly2</code> (see
<code><a href="../articles/migrating.html">vignette("migrating")</a></code> if you are familiar with
<code>orderly1</code>), the line between a plugin and just package code
is fairly blurred, but reasons for writing a plugin are typically that
you want to make something easier in reports, and you want that action
reflected in the orderly metadata.</p>
</div>
<div class="section level3">
<h3 id="an-example">An example<a class="anchor" aria-label="anchor" href="#an-example"></a>
</h3>
<p>As an example, we’ll implement a stripped down version of the
database plugin that inspired this work (see <a href="https://github.com/mrc-ide/orderly.db" class="external-link">`orderly.db</a> for a
fuller implementation). To make this work we need functions:</p>
<ul>
<li>…that process additional fields in <code>orderly_config.yml</code>
that describe where to find the database</li>
<li>…that can be called from an orderly file that access the
database</li>
<li>…that can add metadata to the final orderly metadata about what was
done</li>
</ul>
<p>We’ll start with the report side of things, describing what we want
to happen, then work on the implementation.</p>
<p>Here is the directory structure of our minimal project</p>
<pre><code><span><span class="co">## <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">## ├── orderly_config.yml</span></span>
<span><span class="co">## └── <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">##     └── <span style="color: #0000BB; font-weight: bold;">example</span></span></span>
<span><span class="co">##         └── <span style="color: #00BB00;">example.R</span></span></span></code></pre>
<p>The <code>orderly_config.yml</code> file contains the information
shared by all possible uses of the plugin - in the case the connection
information for the database:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">minimum_orderly_version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.99.0</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">plugins</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="at">  </span><span class="fu">example.db</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="at">    </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /tmp/Rtmp5rsinC/file22596bfc7777</span></span></code></pre></div>
<p>Our plugin is called <code>example.db</code> and is listed within the
<code>plugins</code> section, along with its configuration; in this case
indicating the path where the SQLite file can be loaded from.</p>
<p>The <code>example.R</code> file contains information about use of the
database for this specific report; in this case, making the results of
the query <code>SELECT * from mtcars WHERE cyl == 4</code> against the
database available as some R object <code>dat</code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">example.db</span><span class="fu">::</span><span class="fu">query</span><span class="op">(</span><span class="st">"SELECT * FROM mtcars WHERE cyl == 4"</span><span class="op">)</span></span>
<span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_artefact.html">orderly_artefact</a></span><span class="op">(</span>description <span class="op">=</span> <span class="st">"Summary of data"</span>, <span class="st">"data.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="st">"data.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Normally, we imagine some calculation here but this is kept minimal
for the purpose of demonstration.</p>
<p>To implement this we need to:</p>
<ol style="list-style-type: decimal">
<li>create a package</li>
<li>write a function to handle the configuration in
<code>orderly_config.yml</code>
</li>
<li>write a function <code>query()</code> used in <code>example.R</code>
to do the query itself</li>
</ol>
<div class="section level4">
<h4 id="create-a-tiny-package">Create a tiny package<a class="anchor" aria-label="anchor" href="#create-a-tiny-package"></a>
</h4>
<p>There are lots of package skeleton tools out there, and if you do not
have a favourite, <code>usethis::create_package()</code> will probably
do a reasonable job. The only thing your package needs to do is to
contain <code>Imports: orderly2</code> in its <code>DESCRIPTION</code>
field.</p>
<p>A simple package may have a structure like</p>
<pre><code><span><span class="co">## <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">## ├── DESCRIPTION</span></span>
<span><span class="co">## ├── NAMESPACE</span></span>
<span><span class="co">## └── <span style="color: #0000BB; font-weight: bold;">R</span></span></span>
<span><span class="co">##     └── <span style="color: #00BB00;">plugin.R</span></span></span></code></pre>
<p>Here, our <code>DESCRIPTION</code> file contains:</p>
<pre class="plain"><code>Package: example.db
Version: 0.0.1
License: CC0
Title: Orderly Database Example Plugin
Description: Simple example of an orderly plugin.
Authors@R: person('Orderly Authors', role = c('aut', 'cre'),
    email = 'email@example.com')
Imports: orderly2</code></pre>
<p>and the <code>NAMESPACE</code> and <code>R/plugin.R</code> files are
shown below.</p>
</div>
<div class="section level4">
<h4 id="handle-the-configuration">Handle the configuration<a class="anchor" aria-label="anchor" href="#handle-the-configuration"></a>
</h4>
<p>The only required function that a plugin needs to provide is one to
process the data from <code>orderly_config.yml</code>. This is probably
primarily concerned with validation so can be fairly simple at first,
later we’ll expand this to report errors nicely:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">filename</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The arguments here are</p>
<ul>
<li>
<code>data</code>: the deserialised section of the
<code>orderly_config.yml</code> specific to this plugin</li>
<li>
<code>filename</code>: the full path to
<code>orderly_config.yml</code>
</li>
</ul>
<p>The return value here should be the <code>data</code> argument with
any auxiliary data added after validation.</p>
</div>
<div class="section level4">
<h4 id="evaluate-the-query">Evaluate the query<a class="anchor" aria-label="anchor" href="#evaluate-the-query"></a>
</h4>
<p>Finally, for our minimal example, we need the function that actually
does the query; in our example above this is
<code>example.db::query</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sql</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_context.html">orderly_plugin_context</a></span><span class="op">(</span><span class="st">"example.db"</span><span class="op">)</span></span>
<span>  <span class="va">dbname</span> <span class="op">&lt;-</span> <span class="va">ctx</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">path</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbname</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The arguments here are whatever you want the user to provide –
nothing here is special to <code>orderly2</code>. The important function
here to call is <code><a href="../reference/orderly_plugin_context.html">orderly2::orderly_plugin_context</a></code> which
returns information that you can use to make the plugin work. This is
explained in <code><a href="../reference/orderly_plugin_context.html">?orderly2::orderly_plugin_context</a></code>, but in this
example we use just one element, <code>config</code>, the configuration
for this plugin (i.e., the return value from our function
<code>db_config</code>); see
<code><a href="../reference/orderly_plugin_context.html">orderly2::orderly_plugin_context</a></code> for other context that can
be accessed here.</p>
<p>The last bit of package code is to register the plugin, we do this by
calling <code><a href="../reference/orderly_plugin_register.html">orderly2::orderly_plugin_register</a></code> within
<code>.onLoad()</code> which is a special R function called when a
package is loaded. This means that whenever your packages is loaded
(regardless of whether it is attached) it will register the plugin.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_register.html">orderly_plugin_register</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"example.db"</span>,</span>
<span>    config <span class="op">=</span> <span class="va">db_config</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>(It is important that the <code>name</code> argument here matches
your package name, as orderly2 will trigger loading the package based on
this name in the configuration; we may support multiple plugins within
one package later.)</p>
<p>Note that our <code>query</code> function here does not appear within
this registration, just the function to read and process the
configuration.</p>
<p>Our final (minimal) package code is:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">filename</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sql</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_context.html">orderly_plugin_context</a></span><span class="op">(</span><span class="st">"example.db"</span><span class="op">)</span></span>
<span>  <span class="va">dbname</span> <span class="op">&lt;-</span> <span class="va">ctx</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">path</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbname</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_register.html">orderly_plugin_register</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"example.db"</span>,</span>
<span>    config <span class="op">=</span> <span class="va">db_config</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>and the <code>NAMESPACE</code> file contains</p>
<pre class="plain"><code><span><span class="fu">export</span><span class="op">(</span><span class="va">query</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="trying-it-out">Trying it out<a class="anchor" aria-label="anchor" href="#trying-it-out"></a>
</h4>
<p>In order to test your package, it needs to be loaded. You can do this
by either installing the package or by using
<code><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">pkgload::load_all()</a></code> (you may find doing so with
<code>pkgload::load_all(export_all = FALSE)</code> gives the most
reliable experience.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pkgload</span><span class="fu">::</span><span class="fu"><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Loading <span style="color: #0000BB;">example.db</span></span></span></code></pre>
<p>Now, we can run the report:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"example"</span>, root <span class="op">=</span> <span class="va">path_root</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">example</span>' `20250901-150715-aa1ff35d` at 2025-09-01 15:07:15.673501</span></span>
<span><span class="co">## &gt; dat &lt;- example.db::query("SELECT * FROM mtcars WHERE cyl == 4")</span></span>
<span><span class="co">## &gt; orderly2::orderly_artefact(description = "Summary of data", "data.rds")</span></span>
<span><span class="co">## &gt; saveRDS(summary(dat), "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">example.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150715-aa1ff35d at 2025-09-01 15:07:15.766202 (0.09270167 secs)</span></span>
<span><span class="co">## [1] "20250901-150715-aa1ff35d"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="making-the-plugin-more-robust">Making the plugin more robust<a class="anchor" aria-label="anchor" href="#making-the-plugin-more-robust"></a>
</h2>
<p>The plugin above is fairly fragile because it does not do any
validation on the input data from <code>orderly_config.yml</code> or
<code>orderly.yml</code>. This is fairly annoying to do as yaml is
incredibly flexible and reporting back information to the user about
what might have gone wrong is hard.</p>
<p>In our case, we expect a single key-value pair in
<code>orderly_config.yml</code> with the key being <code>path</code> and
the value being the path to a SQLite database. We can easily expand our
configuration function to report better back to the user when they
misconfigure the plugin:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">filename</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Expected a named list for orderly_config.yml:example.db"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Expected a string for orderly_config.yml:example.db:path"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"The database '%s' does not exist (orderly_config:example.db:path)"</span>,</span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This should do an acceptable job of preventing poor input while
suggesting to the user where they might look within the configuration to
fix it. Note that we return the configuration data here, and you can
augment (or otherwise change) this data as you need.</p>
</div>
<div class="section level2">
<h2 id="saving-metadata-about-what-the-plugin-did">Saving metadata about what the plugin did<a class="anchor" aria-label="anchor" href="#saving-metadata-about-what-the-plugin-did"></a>
</h2>
<p>Nothing about what the plugin does is saved into the report metadata
unless you save it. Partly this is because the orderly.yml, which is
saved into the final directory, serves as some sort of record. However,
you probably want to know something about the data that you returned
here. For example we might want to save</p>
<ul>
<li>the query string so that later we can query it without having to
read and process the <code>orderly.yml</code> file</li>
<li>some statistics about the size of the data (e.g., the number of rows
returned, or the columns)</li>
<li>perhaps some summary of the content such as a hash so that we can
see if the content has changed between different versions of a
report</li>
</ul>
<p>To save metadata, use the function
<code><a href="../reference/orderly_plugin_add_metadata.html">orderly2::orderly_plugin_add_metadata</a></code>; this takes as
arguments your plugin name, any string you like to structure the saved
metadata (here we’ll use <code>query</code>) and whatever data you want
to save:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sql</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_context.html">orderly_plugin_context</a></span><span class="op">(</span><span class="st">"example.db"</span><span class="op">)</span></span>
<span>  <span class="va">dbname</span> <span class="op">&lt;-</span> <span class="va">ctx</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">path</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbname</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span></span>
<span>  <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sql <span class="op">=</span> <span class="va">sql</span>, rows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_add_metadata.html">orderly_plugin_add_metadata</a></span><span class="op">(</span><span class="st">"example.db"</span>, <span class="st">"query"</span>, <span class="va">info</span><span class="op">)</span></span>
<span>  <span class="va">d</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function is otherwise the same as the minimal version above.</p>
<p>We also need to provide a serialisation function to ensure that the
metadata is saved as expected. Because we saved our metadata under the
key <code>query</code>, we will get a list back with an element
<code>query</code> and then an unnamed list with as many elements as
there were <code>query</code> calls in a given report.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_serialise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">query</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Always save cols as a vector, even if length 1:</span></span>
<span>    <span class="va">data</span><span class="op">$</span><span class="va">query</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">query</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cols</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">query</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here, we ensure that everything except <code>cols</code> that is
length 1 (which will be everything) gets turned into a scalar (so
<code>1</code> not <code>[1]</code>) and then serialise with
<code><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">jsonlite::toJSON</a></code> with <code>auto_unbox</code> as
<code>TRUE</code>.</p>
<p>Taking this a step further, we can also specify a <a href="https://json-schema.org/" class="external-link">schema</a> that this metadata will
conform to</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="dt">"$schema"</span><span class="fu">:</span> <span class="st">"http://json-schema.org/draft-07/schema#"</span><span class="fu">,</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"array"</span><span class="fu">,</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    <span class="dt">"items"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>        <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"object"</span><span class="fu">,</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>        <span class="dt">"properties"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>            <span class="dt">"sql"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>                <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"string"</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>            <span class="dt">"rows"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>                <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"number"</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>            <span class="fu">},</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>            <span class="dt">"cols"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>                <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"array"</span><span class="fu">,</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>                <span class="dt">"items"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>                    <span class="dt">"type"</span><span class="fu">:</span> <span class="st">"string"</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>                <span class="fu">}</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>        <span class="dt">"required"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"sql"</span><span class="ot">,</span> <span class="st">"rows"</span><span class="ot">,</span> <span class="st">"cols"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>        <span class="dt">"additionalProperties"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>We save this file as <code>inst/schema.json</code> within the package
(any path within <code>inst</code> is fine).</p>
<p>Finally, we can also add a deserialisation hook to convert the loaded
metadata into a nice <code>data.frame</code>:</p>
<p>Now, when we register the plugin, we provide the path to this schema,
along with the serialisation and deserialisation functions:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_register.html">orderly_plugin_register</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"example.db"</span>,</span>
<span>    config <span class="op">=</span> <span class="va">db_config</span>,</span>
<span>    serialise <span class="op">=</span> <span class="va">db_serialise</span>,</span>
<span>    deserialise <span class="op">=</span> <span class="va">db_deserialise</span>,</span>
<span>    schema <span class="op">=</span> <span class="st">"schema.json"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, when the orderly metadata is saved (just before running the
script part of a report) we will validate output that was passed into
<code><a href="../reference/orderly_plugin_add_metadata.html">orderly2::orderly_plugin_add_metadata</a></code> against the schema,
if <code>jsonvalidate</code> is installed (currently this requires our
development version) and if the R option
<code>outpack.schema_validate</code> is set to <code>TRUE</code> (e.g.,
by running <code>options(outpack.schema_validate = TRUE)</code>).</p>
<p>Our final package has structure:</p>
<pre><code><span><span class="co">## <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">## ├── <span style="color: #0000BB; font-weight: bold;">archive</span></span></span>
<span><span class="co">## │   └── <span style="color: #0000BB; font-weight: bold;">example</span></span></span>
<span><span class="co">## │       └── <span style="color: #0000BB; font-weight: bold;">20250901-150715-aa1ff35d</span></span></span>
<span><span class="co">## │           ├── data.rds</span></span>
<span><span class="co">## │           └── <span style="color: #00BB00;">example.R</span></span></span>
<span><span class="co">## ├── <span style="color: #0000BB; font-weight: bold;">draft</span></span></span>
<span><span class="co">## │   └── <span style="color: #0000BB; font-weight: bold;">example</span></span></span>
<span><span class="co">## ├── orderly_config.yml</span></span>
<span><span class="co">## └── <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">##     └── <span style="color: #0000BB; font-weight: bold;">example</span></span></span>
<span><span class="co">##         └── <span style="color: #00BB00;">example.R</span></span></span></code></pre>
<p>The <code>DESCRIPTION</code> file and <code>NAMESPACE</code> are
unchanged from above, and the schema is shown just above.</p>
<p>The <code>plugin.R</code> file contains the code collected from
above:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">filename</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Expected a named list for orderly_config.yml:example.db"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Expected a string for orderly_config.yml:example.db:path"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>      <span class="st">"The database '%s' does not exist (orderly_config:example.db:path)"</span>,</span>
<span>      <span class="va">data</span><span class="op">$</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sql</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ctx</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_context.html">orderly_plugin_context</a></span><span class="op">(</span><span class="st">"example.db"</span><span class="op">)</span></span>
<span>  <span class="va">dbname</span> <span class="op">&lt;-</span> <span class="va">ctx</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">path</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dbname</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span></span>
<span>  <span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sql <span class="op">=</span> <span class="va">sql</span>, rows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_add_metadata.html">orderly_plugin_add_metadata</a></span><span class="op">(</span><span class="st">"example.db"</span>, <span class="st">"query"</span>, <span class="va">info</span><span class="op">)</span></span>
<span>  <span class="va">d</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_plugin_register.html">orderly_plugin_register</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"example.db"</span>,</span>
<span>    config <span class="op">=</span> <span class="va">db_config</span>,</span>
<span>    serialise <span class="op">=</span> <span class="va">db_serialise</span>,</span>
<span>    deserialise <span class="op">=</span> <span class="va">db_deserialise</span>,</span>
<span>    schema <span class="op">=</span> <span class="st">"schema.json"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>(this code could be in any .R file in the package, or across
several).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_run.html">orderly_run</a></span><span class="op">(</span><span class="st">"example"</span>, root <span class="op">=</span> <span class="va">path_root</span><span class="op">)</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Starting packet '<span style="color: #0000BB;">example</span>' `20250901-150716-bc3373fe` at 2025-09-01 15:07:16.739678</span></span>
<span><span class="co">## &gt; dat &lt;- example.db::query("SELECT * FROM mtcars WHERE cyl == 4")</span></span>
<span><span class="co">## &gt; orderly2::orderly_artefact(description = "Summary of data", "data.rds")</span></span>
<span><span class="co">## &gt; saveRDS(summary(dat), "data.rds")</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Finished running <span style="color: #0000BB;">example.R</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Finished 20250901-150716-bc3373fe at 2025-09-01 15:07:16.780046 (0.04036856 secs)</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu">orderly2</span><span class="fu">::</span><span class="fu"><a href="../reference/orderly_metadata.html">orderly_metadata</a></span><span class="op">(</span><span class="va">id</span>, root <span class="op">=</span> <span class="va">path_root</span><span class="op">)</span></span>
<span><span class="va">meta</span><span class="op">$</span><span class="va">custom</span><span class="op">$</span><span class="va">example.db</span></span>
<span><span class="co">##                                   sql rows         cols</span></span>
<span><span class="co">## 1 SELECT * FROM mtcars WHERE cyl == 4   11 mpg, cyl....</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="potential-uses">Potential uses<a class="anchor" aria-label="anchor" href="#potential-uses"></a>
</h2>
<p>Our need for this functionality are similar to this example - pulling
out the database functionality from the original version of orderly into
something that is more independent, as it turns out to be useful only in
a fraction of orderly use-cases. We can imagine other potential uses
though, such as:</p>
<ul>
<li>Non-DBI-based database data extraction, or customised routines for
pulling data from a database</li>
<li>Download files from some shared location just before use (e.g.,
SharePoint, OneDrive, AWS). The <code>orderly_config.yml</code> would
contain account connection details and <code>orderly.yml</code> would
contain mapping between the remote data/files and local files. Rather
than writing to the environment as we do above, use the
<code>path</code> argument to copy files into the correct place.</li>
<li>Pull data from some web API just before running</li>
</ul>
<p>These all follow the same basic pattern of requiring some
configuration in order to be able to connect to the resource service,
some specification of what resources are to be fetched, and some action
to actually fetch the resource and put it into place.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Robert Ashton, Martin Eden, Alex Hill, Wes Hinsley, Mantra Kusumgar, Paul Liétar, James Thompson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
