<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Start, interact with, and end a packet build — outpack_packet_start • orderly2</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Start, interact with, and end a packet build — outpack_packet_start"><meta property="og:description" content="Start a packet build (outpack_packet_start), end one
(outpack_packet_cancel, outpack_packet_end) and interact with
one (outpack_packet_use_dependency,
outpack_packet_run)"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">orderly2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.99.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/orderly2.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/introduction.html">Introduction to orderly2</a>
    </li>
    <li>
      <a href="../articles/metadata.html">Outpack metadata</a>
    </li>
    <li>
      <a href="../articles/migrating.html">Migrating from orderly (1.x)</a>
    </li>
    <li>
      <a href="../articles/plugins.html">Orderly plugins</a>
    </li>
    <li>
      <a href="../articles/query.html">Outpack query DSL</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mrc-ide/orderly2/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Start, interact with, and end a packet build</h1>
    <small class="dont-index">Source: <a href="https://github.com/mrc-ide/orderly2/blob/HEAD/R/outpack_packet.R" class="external-link"><code>R/outpack_packet.R</code></a></small>
    <div class="hidden name"><code>outpack_packet.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Start a packet build (<code>outpack_packet_start</code>), end one
(<code>outpack_packet_cancel</code>, <code>outpack_packet_end</code>) and interact with
one (<code>outpack_packet_use_dependency</code>,
<code>outpack_packet_run</code>)</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">outpack_packet_start</span><span class="op">(</span></span>
<span>  <span class="va">path</span>,</span>
<span>  <span class="va">name</span>,</span>
<span>  parameters <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  id <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  logging_console <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  logging_threshold <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  root <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">outpack_packet_cancel</span><span class="op">(</span><span class="va">packet</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">outpack_packet_end</span><span class="op">(</span><span class="va">packet</span>, insert <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">outpack_packet_run</span><span class="op">(</span><span class="va">packet</span>, <span class="va">script</span>, envir <span class="op">=</span> <span class="va">.GlobalEnv</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">outpack_packet_use_dependency</span><span class="op">(</span></span>
<span>  <span class="va">packet</span>,</span>
<span>  <span class="va">query</span>,</span>
<span>  <span class="va">files</span>,</span>
<span>  envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  search_options <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">outpack_packet_add_custom</span><span class="op">(</span><span class="va">packet</span>, <span class="va">application</span>, <span class="va">data</span>, schema <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>path</dt>
<dd><p>Path to the build / output directory.</p></dd>


<dt>name</dt>
<dd><p>The name of the packet</p></dd>


<dt>parameters</dt>
<dd><p>Optionally, a named list of parameters.  The
names must be unique, and the values must all be non-NA scalar
atomics (logical, integer, numeric, character)</p></dd>


<dt>id</dt>
<dd><p>Optionally, an outpack id via <a href="outpack_id.html">outpack_id</a>. If
not given a new id will be generated.</p></dd>


<dt>logging_console</dt>
<dd><p>Optional logical, indicating if we should
override the root's default in logging to the console. A value
of <code>NULL</code> uses the root value, <code>TRUE</code> enables console output
even when this is suppressed by the root, and <code>FALSE</code> disables
it even when this is enabled by the root.</p></dd>


<dt>logging_threshold</dt>
<dd><p>Optional log threshold, indicating if we
override the root's default in logging to the console. A value
of <code>NULL</code> uses the root value, otherwise use <code>info</code>, <code>debug</code> or
<code>trace</code> (in increasing order of verbosity).</p></dd>


<dt>root</dt>
<dd><p>The outpack root. Will be searched for from the
current directory if not given.</p></dd>


<dt>packet</dt>
<dd><p>A packet object</p></dd>


<dt>insert</dt>
<dd><p>Logical, indicating if we should insert the packet
into the store. This is the default and generally what you
want. The use-case we have for <code>insert = FALSE</code> is where you
want to write out all metadata after a failure, and in this case
you would not want to do a final insertion into the outpack
archive. When <code>insert = FALSE</code>, we write out the json metadata
that would have been written as <code>outpack.json</code> within the packet
working directory.  Note that this skips a lot of validation
(for example, validating that all files exist and that files
marked immutable have not been changed)</p></dd>


<dt>script</dt>
<dd><p>Path to the script within the packet directory (a
relative path).  This function can be safely called multiple
times within a single packet run (or zero times!) as needed.</p></dd>


<dt>envir</dt>
<dd><p>Optional environment for <code>environment:</code> lookups in
<code>query</code>, and for interpolating filenames in <code>files</code>; the default
is to use the parent frame, but other suitable options are the
global environment or the environment of the script you are
running (this only relevant if you have <code>environment:</code> lookups
in <code>query</code>).</p></dd>


<dt>query</dt>
<dd><p>An <a href="outpack_query.html">outpack_query</a> object, or something
(e.g., a string) that can be trivially converted into one.</p></dd>


<dt>files</dt>
<dd><p>Files to copy from the other packet. This can be (1)
a character vector, in which case files are copied over without
changing their names, (2) a <strong>named</strong> character vector, in which
case the name will be used as the destination name, or (3) a
<a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a> (including <code>tbl_df</code>, or <code>data.frame</code> objects)
containing columns <code>from</code> and <code>to</code>, in which case the files
<code>from</code> will be copied with names <code>to</code>.</p>
<p>In all cases, if you want to import a directory of files from a
packet, you must refer to the source with a trailing slash
(e.g., <code>c(here = "there/")</code>), which will create the local
directory <code>here/...</code> with files from the upstream packet
directory <code>there/</code>. If you omit the slash then an error will be
thrown suggesting that you add a slash if this is what you
intended.</p>
<p>You can use a limited form of string interpolation in the names of
this argument; using <code>${variable}</code> will pick up values from
<code>envir</code> and substitute them into your string.  This is similar
to the interpolation you might be familiar with from
<code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue::glue</a></code> or similar, but much simpler with no concatenation
or other fancy features supported.</p>
<p>Note that there is an unfortunate, but (to us) avoidable
inconsistency here; interpolation of values from your
environment in the query is done by using <code>environment:x</code> and in
the destination filename by doing <code>${x}</code>.</p></dd>


<dt>search_options</dt>
<dd><p>Optional search options for restricting the
search (see <a href="outpack_search.html">outpack_search</a> for details)</p></dd>


<dt>overwrite</dt>
<dd><p>Overwrite files at the destination; this is
typically what you want, but set to <code>FALSE</code> if you would prefer
that an error be thrown if the destination file already exists.</p></dd>


<dt>application</dt>
<dd><p>The name of the application (used to organise
the data and query it later, see Details)</p></dd>


<dt>data</dt>
<dd><p>Additional metadata to add to the packet. This must be
a string representing already-serialised json data.</p></dd>


<dt>schema</dt>
<dd><p>Optionally, but recommended, a schema to validate
<code>data</code> against.  Validation will only happen if the option
<code>outpack.schema_validate</code> is <code>TRUE</code>, as for the main schema
validation.  Will be passed to <a href="https://docs.ropensci.org/jsonvalidate/reference/json_schema.html" class="external-link">jsonvalidate::json_schema</a>, so
can be a string containing the schema or a path to the schema.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>Invisibly, a copy of the packet data; this can be passed
as the <code>packet</code> argument.</p>
    </div>
    <div id="running-scripts">
    <h2>Running scripts</h2>
    


<p>R does not make it extremely easy to "run" a script while
collecting output and warnings in a nice way; this is something
you may be familiar with when running scripts through things
like knitr where differences in behaviour between running from
within knitr and R are not uncommon.  If you see any behaviour
which feels very different to what you expect please let us
know.</p>
<p>One area of known difference is that of warnings; what R does with
warnings depends on a number of options - both global and to
<code>warning</code> itself. We do not try very hard currently to get the
same behaviour with warnings as you might see running directly
with <code>source</code> and observing your terminal, partly because we
hope that in practice your code will produce very few warnings.</p>
<p>On failure in the script, <code>outpack_packet_run</code> will throw, forcing
any function that calls <code>outpack_packet_run</code> to explicitly cope
with error. The error that is generated will have class
<code>outpack_packet_run_error</code> allowing this error to be easily
distinguished from other R errors. It will have, in addition to
a <code>message</code> field, additional data fields containing information
about the error:</p><ul><li><p><code>error</code>: the original error object, as thrown and caught by <code>outpack</code></p></li>
<li><p><code>traceback</code>: the backtrace for the above error, currently just as a
character vector, though this may change in future versions</p></li>
<li><p><code>output</code>: a character vector of interleaved stdout and stderr as
the script ran</p></li>
<li><p><code>warnings</code>: a list of warnings raised by the script</p></li>
</ul><p>The other reason why the script may fail is that it fails to
balance one of the global resource stacks - either connections
(rare) or graphics devices (easy to do). In this case, we still
throw a (classed) error, but the <code>error</code> field in the final
error will be <code>NULL</code>, with an informative message explaining
what was not balanced.</p>
    </div>
    <div id="dependency-resolution">
    <h2>Dependency resolution</h2>
    


<p>The <code>search_options</code> argument controls where outpack searches for
packets with the given query and if anything might be moved over
the network (or from one outpack archive to another). By default
everything is resolved locally only; that is we can only depend
on packets that are unpacked within our current archive.  If you
pass a <code>search_options</code> argument that contains <code>allow_remote = TRUE</code> (see <a href="outpack_search_options.html">outpack_search_options</a> then packets
that are known anywhere are candidates for using as dependencies
and <em>if needed</em> we will pull the resolved files from a remote
location. Note that even if the packet is not locally present
this might not be needed - if you have the same content anywhere
else in an unpacked packet we will reuse the same content
without re-fetching.</p>
<p>If <code>pull_metadata = TRUE</code>, then we will refresh location metadata
before pulling, and the <code>location</code> argument controls which
locations are pulled from.</p>
    </div>
    <div id="custom-metadata">
    <h2>Custom metadata</h2>
    


<p>The <code>outpack_packet_add_custom</code> function adds arbitrary
additional metadata into a packet. It is primarily designed for
use with applications that build on outpack to provide
additional information beyond the minimal set provided by
outpack.</p>
<p>For example, orderly tracks "artefacts" which collect groups of
file outputs into logical bundles.  To support this it needs to
register additional data for each artefact with:</p><ul><li><p>the description of the artefact (a short phrase)</p></li>
<li><p>the format of the artefact (a string describing the data type)</p></li>
<li><p>the contents of the artefact (an array of filenames)</p></li>
</ul><p>JSON for this might look like:</p>
<p></p><div class="sourceCode json"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"artefacts"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Data for onward use"</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"format"</span><span class="fu">:</span> <span class="st">"data"</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"contents"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"results.rds"</span><span class="ot">,</span> <span class="st">"summary.rds"</span><span class="ot">]</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"description"</span><span class="fu">:</span> <span class="st">"Diagnostic figures"</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"format"</span><span class="fu">:</span> <span class="st">"staticgraph"</span><span class="fu">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">"contents"</span><span class="fu">:</span> <span class="ot">[</span><span class="st">"fits.png"</span><span class="ot">,</span> <span class="st">"inputs.png"</span><span class="ot">]</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre><p></p></div>
<p>Here, we describe two artefacts, together collecting four files.</p>
<p>We need to store these in outpack's final metadata, and we want to
do this in a way that allows easy querying later on while
scoping the data to your application.  To allow for this we
group all data your application adds under an application key
(e.g., <code>orderly</code>).  You can then store whatever data you want
beneath this key.</p>
<p><strong>NOTE1</strong>: A limitation here is that the filenames above cannot be
checked against the outpack list of files because outpack does
not know that <code>contents</code> here refers to filenames.</p>
<p><strong>NOTE2</strong>: To allow for predictable serialisation to JSON, you
must serialise your own data before passing through to
<code>outpack_packet_add_custom</code>.</p>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Rich FitzJohn, Robert Ashton, Alex Hill.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

